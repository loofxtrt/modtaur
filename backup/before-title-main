from pathlib import Path
import shutil
import json
import requests

import logger

DOTMINECRAFT = Path.home() / '.minecraft'
API_BASE = 'https://api.modrinth.com/v2'
HEADERS = {"User-Agent": "modtaur/0.1"}

def download_jar(url: str, filename: str, destination_dir: Path):
    down = requests.get(url, stream=True)
    down.raise_for_status()

    destination = destination_dir / filename
    with destination.open('wb') as dest:
        for chunk in down.iter_content(chunk_size=8192):
            dest.write(chunk)

    return destination

def get_project_data(slug: str, version: str, loader: str = 'fabric'):
    project = f'{API_BASE}/project/{slug}/version'
    
    try:
        resp = requests.get(project, headers=HEADERS)
        resp.raise_for_status()
        resp = resp.json()
    except requests.exceptions.HTTPError:
        logger.error(f'não foi possível obter os dados de {projects}. isso provavelmente aconteceu por um slug inexistente')
        return

    target = None
    for i in resp:
        game_versions = i.get('game_versions')
        if not version in game_versions:
            continue

        loaders = i.get('loaders')
        if not loader in loaders:
            continue

        target = i
        break
    
    if target is None:
        logger.error('alvo não encontrado, possívelmente por não ser compatível com o loader ou versão')
        return
    
    files = target.get('files')
    if len(files) > 1:
        logger.warning('o projeto possui mais de um arquivo disponível. baixando apenas o primário')

    primary = None
    for f in files:
        if not f.get('primary', False):
            continue
        
        primary = f
        break
    if primary is None:
        logger.warning('primário não encontrado, usando o primeiro item da lista como fallback')
        primary = files[0]
    if primary is None:
        logger.error('o projeto não possui nenhum arquivo disponível')
        return

    url = primary.get('url')
    filename = primary.get('filename')

    #download_jar(url, filename)
    return url, filename

def write_modpack(version: str, slugs: list, loader: str = 'fabric'):
    for s in slugs:
        download_from_modrinth

def load_modpack(modpack: Path, downloaded_dir: Path, delete_previous: bool = False):
    mods = DOTMINECRAFT / 'mods'
    mods.mkdir(exist_ok=True, parents=True)

    if delete_previous:
        logger.info('deletando todos os mods anteriores')
        for f in mods.rglob('*'):
            f.unlink()
        logger.success('mods deletados')

    with modpack.open('r', encoding='utf-8') as mp:
        data = json.load(mp)
    
    version = data.get('version')
    loader = data.get('loader')
    slugs = data.get('slugs')

    for s in slugs:
        res = get_project_data(s, version, loader)
        if not res:
            logger.warning('pulando, erro ao obter os dados do projeto', s)
            continue
        url, filename = res

        found = None
        for f in downloaded_dir.rglob('*.jar'):
            if f.name == filename:
                found = f
        
        if found is not None:
            logger.success('mod já baixado encontrado', s)
            shutil.copy2(found, mods)
        else:
            logger.info('iniciando download', s)
            dest = download_jar(url, filename, mods)
            subdown = downloaded_dir / version
            subdown.mkdir(exist_ok=True)
            shutil.copy2(dest, subdown)
            logger.success('download concluído', s)

#download_from_modrinth('sodium', '1.20.1', 'fabric')
load_modpack(Path('./modpacks/visuals.json'), Path('./downloads'))